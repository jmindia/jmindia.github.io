<!-- ===========================
File: receiver.html
Purpose: Custom Cast Web Receiver that renders a 5-ticker TradingView dashboard and listens for updates from sender.
Host this file at a public HTTPS URL and register it as a Custom Receiver in the Google Cast SDK Console.
=========================== -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Dashboard Receiver</title>
  <script defer src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <style>
    :root { --bg:#0b1022; --panel:#0e1628; --text:#e5e7eb; --muted:#94a3b8; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { height:100%; display:flex; flex-direction:column; }
    header { padding: 16px 24px; display:flex; justify-content:space-between; align-items:center; background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); border-bottom:1px solid rgba(255,255,255,0.06); }
    .tickers { letter-spacing: 1px; font-weight: 700; opacity: 0.9; }
    .clock { color: var(--muted); font-weight:600; }
    main { flex:1; padding: 12px; display:grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 12px; }
    .one { grid-column: span 3; height: 48%; }
    .widget { background: var(--panel); border-radius: 16px; padding: 6px; overflow:hidden; }
    footer { text-align:center; padding: 8px; color: var(--muted); font-size: 12px; }
    @media (max-aspect-ratio: 16/10) { main { grid-template-columns: 1fr; grid-template-rows: repeat(5, 1fr); } .one { grid-column: span 1; height:auto; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="tickers" id="tickerList">AAPL • MSFT • NVDA • GOOGL • AMZN</div>
      <div class="clock" id="clock">--:--:--</div>
    </header>
    <main id="grid">
      <!-- widgets injected here -->
    </main>
    <footer>Data & charts by TradingView (for display only)</footer>
  </div>

  <script>
    const NAMESPACE = 'urn:x-cast:ticker.dashboard';
    const DEFAULT_TICKERS = ['AAPL','MSFT','NVDA','GOOGL','AMZN'];

    const context = cast.framework.CastReceiverContext.getInstance();
    const channel = new cast.framework.system.EventChannel(NAMESPACE);

    function startClock(){
      const el = document.getElementById('clock');
      const upd = () => { el.textContent = new Date().toLocaleTimeString(); };
      upd(); setInterval(upd, 1000);
    }

    function setTickerHeader(arr){
      document.getElementById('tickerList').textContent = arr.join(' • ');
      document.title = `Stocks: ${arr.join(' / ')}`;
    }

    function renderWidgets(tickers){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      // First widget: multi-symbol overview across the top
      const top = document.createElement('div');
      top.className = 'widget one';
      top.innerHTML = `<div class="tradingview-widget-container" style="height:100%"><div class="tradingview-widget-container__widget"></div></div>`;
      grid.appendChild(top);

      const topScript = document.createElement('script');
      topScript.src = 'https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js';
      topScript.async = true;
      topScript.innerHTML = JSON.stringify({
        symbols: tickers.map(t => [t]),
        chartOnly: false,
        width: '100%',
        height: '100%',
        locale: 'en',
        colorTheme: 'dark',
        autosize: true,
        showVolume: false,
        showMA: false,
        hideDateRanges: false,
        hideMarketStatus: false,
        hideSymbolLogo: false,
        scalePosition: 'right',
        scaleMode: 'Normal',
        fontFamily: 'inherit',
        gridLineColor: 'rgba(42, 46, 57, 0.06)',
        backgroundColor: 'rgba(14,22,40,1)',
        noTimeScale: false,
        chartType: 'area',
        lineWidth: 2,
        widgetFontColor: '#e5e7eb',
      });
      top.querySelector('.tradingview-widget-container').appendChild(topScript);

      // Individual mini charts below (up to 4; if more than 4 tickers, we still show first 4 here)
      const minis = tickers.slice(0, 4);
      minis.forEach(sym => {
        const cell = document.createElement('div');
        cell.className = 'widget';
        cell.innerHTML = `<div class="tradingview-widget-container" style="height:100%"><div class="tradingview-widget-container__widget"></div></div>`;
        grid.appendChild(cell);

        const s = document.createElement('script');
        s.src = 'https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js';
        s.async = true;
        s.innerHTML = JSON.stringify({
          symbol: sym,
          width: '100%',
          height: '100%',
          locale: 'en',
          dateRange: '1D',
          colorTheme: 'dark',
          isTransparent: true,
          autosize: true,
          largeChartUrl: '',
          noTimeScale: false
        });
        cell.querySelector('.tradingview-widget-container').appendChild(s);
      });
    }

    function applyTickers(tickers){
      if(!Array.isArray(tickers) || tickers.length === 0) tickers = DEFAULT_TICKERS;
      tickers = tickers.slice(0,5).map(s => String(s).trim().toUpperCase()).filter(Boolean);
      setTickerHeader(tickers);
      renderWidgets(tickers);
    }

    // Listen for custom messages from the sender
    context.addCustomMessageListener(NAMESPACE, (event) => {
      try {
        const data = event.data || {};
        applyTickers(data.tickers);
      } catch(err){
        // ignore malformed messages
      }
    });

    // Start the receiver
    context.start();

    // Initial render
    startClock();
    applyTickers(DEFAULT_TICKERS);
  </script>
</body>
</html>
