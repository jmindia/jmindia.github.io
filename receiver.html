<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Board Receiver</title>
  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root { color-scheme: dark; }
    html, body { margin: 0; background:#0b1220; color:#e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial; }
    #grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; padding: 12px; }
    .card { height: 260px; background: #0f172a; border-radius: 16px; padding: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.2) inset; }
    .row { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
    .badge { opacity:.75; font-size:12px; }
  </style>
</head>
<body>
  <div id="grid"></div>
  <script>
    const context = cast.framework.CastReceiverContext.getInstance();
    const messageBus = context.getCastMessageBus('urn:x-cast:app.stocks');

    const state = {
      tickers: ['AAPL','MSFT','GOOGL','AMZN','NVDA'],
      apiKey: null,
      interval: 'DAILY' // 'DAILY' | 'INTRADAY'
    };

    const grid = document.getElementById('grid');

    async function fetchSeries(symbol, apiKey, interval='DAILY') {
      const fn = interval === 'INTRADAY' ? 'TIME_SERIES_INTRADAY&interval=5min' : 'TIME_SERIES_DAILY_ADJUSTED';
      const url = `https://www.alphavantage.co/query?function=${fn}&symbol=${encodeURIComponent(symbol)}&apikey=${apiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      const key = interval==='INTRADAY' ? 'Time Series (5min)' : 'Time Series (Daily)';
      const ts = data[key] || {};
      const points = Object.keys(ts).slice(0, 180).reverse().map(d => {
        const o = ts[d];
        return {
          time: Math.floor(new Date(d).getTime()/1000),
          open: +o['1. open'],
          high: +o['2. high'],
          low: +o['3. low'],
          close: +o['4. close']
        };
      });
      return points;
    }

    function makeCard(sym) {
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.innerHTML = `
        <div class="row"><strong>${sym}</strong><span id="status-${sym}" class="badge">loadingâ€¦</span></div>
        <div id="chart-${sym}" style="width:100%;height:210px;"></div>
      `;
      grid.appendChild(wrap);
      const chart = LightweightCharts.createChart(document.getElementById(`chart-${sym}`), {
        layout:{ background:{ type:'solid', color:'#0f172a' }, textColor:'#cbd5e1' },
        grid:{ vertLines:{ color:'#182235' }, horzLines:{ color:'#182235' } },
        rightPriceScale:{ borderVisible:false }, timeScale:{ borderVisible:false }
      });
      const series = chart.addCandlestickSeries();
      return { chart, series };
    }

    async function render() {
      grid.innerHTML = '';
      const apiKey = state.apiKey || 'demo'; // 'demo' works only for MSFT
      for (const sym of state.tickers.slice(0,5)) {
        const { series } = makeCard(sym);
        try {
          const data = await fetchSeries(sym, apiKey, state.interval);
          const status = document.getElementById(`status-${sym}`);
          if (data.length) { series.setData(data); status.textContent = `${data.length} pts`; }
          else { status.textContent = 'no data'; }
        } catch (e) {
          const status = document.getElementById(`status-${sym}`);
          status.textContent = 'error';
        }
        await new Promise(r => setTimeout(r, 1200)); // be gentle with free API limits
      }
    }

    messageBus.onMessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.tickers) state.tickers = msg.tickers.map(s => s.toUpperCase());
        if (msg.apiKey) state.apiKey = msg.apiKey;
        if (msg.interval) state.interval = msg.interval;
        render();
      } catch (_) {}
    };

    context.start();
    render();
  </script>
</body>
</html>
